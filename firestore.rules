/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for the TrafficFlow application.
 *
 * Core Philosophy:
 * The security model prioritizes authorization independence through data denormalization.
 * Access to JobPacks and their subcollections is controlled by a `members` map on the JobPack document.
 * User-specific data (like Staff) is stored under `/users/{userId}` to enforce ownership.
 * Public listing is disabled for collections containing private data.
 *
 * Data Structure:
 * - /job_packs/{jobPackId}: Contains job pack information and a `members` map for access control.
 * - /job_packs/{jobPackId}/permit: Permit data associated with a job pack.
 * - /job_packs/{jobPackId}/schedule: Schedule data associated with a job pack.
 * - /job_packs/{jobPackId}/hazard_logs/{hazardLogId}: Hazard logs associated with a job pack.
 * - /job_packs/{jobPackId}/equipment_checklist: Equipment checklist associated with a job pack.
 * - /job_packs/{jobPackId}/completion_sign_off: Completion sign-off associated with a job pack.
 * - /trucks/{truckId}: Contains truck information.
 * - /trucks/{truckId}/defect_report: Defect reports associated with a truck.
 * - /trucks/{truckId}/fuel_logs/{fuelLogId}: Fuel logs associated with a truck.
 * - /users/{userId}/staff/{staffId}: Staff data specific to a user.
 * - /certifications/{certificationId}: Certification data.
 *
 * Key Security Decisions:
 * - JobPack access is governed by the `members` map within each JobPack document.  This map dictates who can read and write to the JobPack and its associated subcollections.
 * - Staff data is private and scoped to each user. Only the user can access their own staff records.
 * - Public listing is generally disallowed for collections containing user-specific or potentially sensitive data.
 *
 * Denormalization for Authorization:
 * - JobPacks contain a `members` map (e.g., `{ members: { 'user_abc': 'editor' } }`) that defines user roles for that specific job pack. This allows for authorization checks without needing to query separate collections.
 *
 * Structural Segregation:
 * - Staff data is stored under `/users/{userId}/staff/{staffId}` to ensure private, user-scoped access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages job pack data and access control.
     * @path /job_packs/{jobPackId}
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isMember check once the schema is updated with an members field.
     * @deny (create): if request.resource.data.keys().hasAny(['hazardLogIds','equipmentChecklistId','completionSignOffId','permitId','scheduleId']);
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /job_packs/{jobPackId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isMember check once the schema is updated with an members field.
    }

    /**
     * @description Manages permit data associated with a job pack.  Authorization inherited from parent JobPack.
     * @path /job_packs/{jobPackId}/permit
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isMember check once the schema is updated with an members field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /job_packs/{jobPackId}/permit {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isMember check once the schema is updated with an members field.
    }

    /**
     * @description Manages schedule data associated with a job pack. Authorization inherited from parent JobPack.
     * @path /job_packs/{jobPackId}/schedule
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isMember check once the schema is updated with an members field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /job_packs/{jobPackId}/schedule {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isMember check once the schema is updated with an members field.
    }

    /**
     * @description Manages hazard logs associated with a job pack. Authorization inherited from parent JobPack.
     * @path /job_packs/{jobPackId}/hazard_logs/{hazardLogId}
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isMember check once the schema is updated with an members field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /job_packs/{jobPackId}/hazard_logs/{hazardLogId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isMember check once the schema is updated with an members field.
    }

    /**
     * @description Manages equipment checklist data associated with a job pack. Authorization inherited from parent JobPack.
     * @path /job_packs/{jobPackId}/equipment_checklist
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isMember check once the schema is updated with an members field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /job_packs/{jobPackId}/equipment_checklist {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isMember check once the schema is updated with an members field.
    }

    /**
     * @description Manages completion sign-off data associated with a job pack. Authorization inherited from parent JobPack.
     * @path /job_packs/{jobPackId}/completion_sign_off
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if isSignedIn();
     * @allow (update, delete): if false; // TODO: Add isMember check once the schema is updated with an members field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /job_packs/{jobPackId}/completion_sign_off {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isMember check once the schema is updated with an members field.
    }

    /**
     * @description Manages truck data.
     * @path /trucks/{truckId}
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isTruckAdmin() check once the schema is updated with an members field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /trucks/{truckId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isTruckAdmin() check once the schema is updated with an admin role field.
    }

    /**
     * @description Manages defect reports associated with a truck.
     * @path /trucks/{truckId}/defect_report
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isTruckAdmin() check once the schema is updated with an admin role field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /trucks/{truckId}/defect_report {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isTruckAdmin() check once the schema is updated with an admin role field.
    }

    /**
     * @description Manages fuel logs associated with a truck.
     * @path /trucks/{truckId}/fuel_logs/{fuelLogId}
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isTruckAdmin() check once the schema is updated with an admin role field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /trucks/{truckId}/fuel_logs/{fuelLogId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isTruckAdmin() check once the schema is updated with an admin role field.
    }

    /**
     * @description Manages staff data specific to a user.
     * @path /users/{userId}/staff/{staffId}
     * @allow (get, list): if isOwner(userId);
     * @allow (create): if isOwner(userId);
     * @allow (update, delete): if isExistingOwner(userId);
     * @principle: Enforces ownership: only the user can access their own staff data.
     */
    match /users/{userId}/staff/{staffId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages certification data.
     * @path /certifications/{certificationId}
     * @allow (get, list): if true; // Public read access.
     * @allow (create): if request.auth != null;
     * @allow (update, delete): if false; // TODO: Add isCertificationAdmin() check once the schema is updated with an admin role field.
     * @principle: Enforces access control through a members map, where authorized users and their roles are stored.
     */
    match /certifications/{certificationId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add isCertificationAdmin() check once the schema is updated with an admin role field.
    }

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}